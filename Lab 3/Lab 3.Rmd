---
title: "Lab 3"
output: html_document
---

# STAT 332: Lab 3

## 1.) Setup

Welcome to Lab 3. This week we are going to be working with alternatives to igraph.\
This means that we want to get familiar with the tools from ggraph (<https://ggraph.data-imaginist.com/index.html>) and visNetwork (<https://datastorm-open.github.io/visNetwork/>).

We're going to be using the same data as lab 2 and trying to reproduce the same graph as last time, so lets get started.

## 2.) Lab Walkthrough

### 2.a) Getting started.

Using ctrl-alt-i you can create a section where you are going to embed R code. We're going to start by loading in the igraph library.

```{r setup}
library(igraph)       # Our standard graph object.
library(readr)        # Reading in the data
library(ggraph)       # Plotting
library(tidygraph)    # Managing our graph object
library(RColorBrewer) # Getting Colors
library(scales)       # scaling factors
library(grid)         # for unit()
library(ggrepel)      # for stronger label repel
library(visNetwork)   # for network graphs
library(ggraph)       # for graphs
library(ggplot2)      # for ploots
library(grid)         # 
```

```{r utility_functions}
print_igraph_attr <- function(graph) {
  print("--- Graph Attributes ------")
  print(graph_attr(graph))
  
  print("--- Vertex Attributes ------")
  print(vertex_attr(graph))
  
  print("--- Edge Attributes ------")
  print(edge_attr(graph))
}
```

```{r}
g <- read_rds("Media Network.rds")
```

Just to remind ourselves of what we're working with, let's make sure we print out our vertex and edge attributes

```{r}
g
print_igraph_attr(g)
```

### 2b.) Adding degree strength as attributes

Just like last week, we want to add a few more attributes.

```{r}
g <- set_vertex_attr(g, name = "strength_in", value = strength(g, mode = "in"))
g <- set_vertex_attr(g, name = "strength_out", value = strength(g, mode = "out"))
g <- set_vertex_attr(g, name = "strength_total", value = strength(g, mode = "total"))
```

Let's make sure we have our new attributes.

```{r}
summary(g)
```

### 2d.) Let's graph

This time, we're going to use

```{r}
g %>%  #Start with the graph object
  ggraph(layout = "lgl") + # initializes the plot
  geom_node_point() + #adds the nodes to the plot
  geom_edge_link()  #adds the edges to the plot
```

Alright, that's the basics.

```{r}
g %>%
  ggraph(layout = "lgl") +
  geom_node_point(
    aes(size = audience.size, fill = type.label, shape = type.label),
    colour = "grey30", 
    alpha = 0.5, 
    stroke = 0.4
    ) +
  geom_node_text(
    aes(label = media), 
    repel = TRUE, 
    size = 3
    ) + 
  geom_edge_link(
    aes(colour = type, linetype = type, width = weight),
    alpha = 0.5, 
    lineend = "round",
    arrow = arrow(type = "closed"),
    end_cap = circle()
    ) + 
  labs(
    title    = "Media Networks Link to and Reference Each Other",
    subtitle = "A network plot of networks.",
    caption  = "Data from: https://kateto.net/network-visualization."
   )
```

Okay, it's not perfect. We can do better, but the format is just so much better. Let's fix the scales next:

```{r}
library(ggraph)
library(ggplot2)
library(grid)

# Shape mapping (3 shapes)
node_types <- sort(unique(V(g)$type.label))
shape_vals <- c(21, 22, 24)[seq_along(node_types)]
shape_map  <- setNames(shape_vals, node_types)

p <- ggraph(g, layout = "lgl") +
  geom_node_point(
    aes(size = audience.size, fill = type.label, shape = type.label),
    alpha  = 0.6
  ) +
  geom_node_text(
    aes(label = media),
    repel = TRUE,
    size  = 3
  ) +
  
  geom_edge_arc(
    aes(colour = type, linetype = type, width = weight),
    alpha   = 0.4,
    lineend = "round",
    arrow   = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(2, "mm"), 
    strength = 0.3
  ) +
  
  
  scale_size_continuous(name = "Audience Size", range = c(1, 8)) +
  scale_shape_manual(values = shape_map, guide = "none") +
  scale_edge_width(range = c(0.5, 1.5), guide = "none") +
  scale_edge_linetype(guide = "none") + 
  
  guides(
    size  = guide_legend(nrow = 2, byrow = T),
    fill = guide_legend(nrow = 1, byrow = T, title = "Verex Color/Shape",
      override.aes = list(shape = shape_vals)),
    edge_colour = guide_legend(ncol = 2, byrow = T, 
                               title = "Reference Type")
    ) + 
  
  labs(
    title    = "Media Networks Link to and Reference Each Other",
    subtitle = "A network plot of networks.",
    caption  = "Data from: https://kateto.net/network-visualization."
  ) 

  p
```

If you're paying attention, you might notice that I stored the graph as the variable p and then called it by just using "p" at the end of the code cell. I did this for a reason. In ggplot, we can theme our graphs. <https://ggplot2.tidyverse.org/reference/theme.html>\
\

```{r}
p + theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.box.background = element_rect(color = "black", size = 0.5),
    legend.box.margin = margin(1, 1, 1, 1),
  ) 
```

## 3.) Your turn:

In the data for this lab, there are two files (and a paper describing where they came from.) The Actor Roles provides the list of nodes and their corresponding attributes. The "Table 2" file provides a matrix of associations and their strengths that you can read in as a matrix and extract the edglist from. Please create a graph which uses shapes, colors, and edge-widths to represent this network. Also, please make sure to use both color and type on edges to denote any edge relationships between Command Team members and any other members in the network. Use GGRAPH to produce this plot. Be certain to add titles, subtitles, and footnotes/captions as appropriate and include a corresponding legend.

```{r}
# read in data file
# extract edge list
# create graph using ggraph
# custom shapes
# custom colors
# custom edge widths
# use custom color AND type on edges to denote Command Team members
# title
# subtitle
# footnotes
# captions
# legend
```

## 4.)  visNetwork

```{r}
library(visNetwork)
```

As opposed to the ggplot framework where most of the plot information is taken care of within the plot code, visNetwork is generally done by taking care of most of the information outside of the plotting code. This is done by creating data frames for the nodes and edges separately and then adding attributes with special names to them. For example, a node or edge attribute of "title" will be the information for the tooltip which pops up on hover-over by the mouse. The "group" is specifically used for the legend.

```{r}
# Build nodes
nodes <- igraph::as_data_frame(g, what = "vertices") %>%
  tibble::rownames_to_column("id") %>%
  mutate(
    id    = as.character(id),
    label = media,
    value = audience.size,
    group = type.label
  )

# Shape mapping
node_types <- sort(unique(nodes$group))
shape_vals <- c("dot", "square", "triangle")[seq_along(node_types)]
shape_map  <- setNames(shape_vals, node_types)
nodes$shape <- shape_map[nodes$group]

# Node colors (background)
node_colors <- setNames(scales::hue_pal()(length(node_types)), node_types)
nodes$color.background <- node_colors[nodes$group]
nodes$color.border <- "#444444"

nodes$title <- paste("Media Name: ", nodes$media, "<br>Media Type: ", nodes$type.label, "<br>Audience Size: ", nodes$audience.size)

# Build edges
edges <- igraph::as_data_frame(g, what = "edges") %>%
  mutate(
    from   = as.character(from),
    to     = as.character(to),
    width  = scales::rescale(weight, to = c(0.5, 1.5)),
    arrows = "to",
    smooth = TRUE
  )

# Edge colors
edge_types <- sort(unique(edges$type))
edge_colors <- setNames(scales::hue_pal()(length(edge_types)), edge_types)
edges$color <- edge_colors[edges$type]

# Dash mapping (linetype analogue)
edges$dashes <- edges$type == edge_types[2]   # example: second type dashed

edges$title <- paste("Reference Type: ", edges$type)
```

There are disadvantages to storing data this way (for example, what if the title attribute was natural in the dataset to represent the a political title?) But, once the data is in, it becomes very easy to produce a really good plot automatically.

```{r}
vis <- visNetwork(nodes, edges,
    main    = "Media Networks Link to and Reference Each Other",
    submain = "A network plot of networks.",
    footer  = "Data from: https://kateto.net/network-visualization.",
    width = "100%"
    )%>%
  visNodes(scaling = list(min = 5, max = 30)) %>%
  visEdges(smooth = list(enabled = TRUE, type = "dynamic")) %>%
  visOptions(
    highlightNearest = TRUE,
    nodesIdSelection = TRUE,
    collapse = TRUE
  ) %>%
  visInteraction(
    dragNodes = TRUE,
    dragView  = TRUE,
    zoomView  = TRUE
  ) %>%
  visPhysics(stabilization = TRUE)

vis
```

## 5.)  Your Turn 

Reproduce the same graph as above (or close to it, showing the same information) using visNetwork. Make the tooltip display the individual's name and their role. Don't worry about a legend on this plot.

```{r}
# make graph with visNetwork

# tooltip w/ individual's name and role

# no legend

```

#### Something to think about.

How centralized is this network? Are there any key players that could be removed to make the network fail in their goals? Centralized networks are highly resilient but also insecure, which can play into strategies when analyzing these networks. We'll talk about a number of measures of network structure next week.

Centrality measures stuff here!

```{r}

```

## 6.) Results

What you need to do next is to "knit" your document into an html using the "Knit" button near the top of the screen. This will give you an HTML that you can turn in.
